## 限流相关知识

### 目录
   - [限流模式](#限流模式)
   - [流控策略](#流控策略)
   - [参考文章](#参考文章)
   - [限流算法](#限流算法)


### 限流模式

    1. 线程池模式：系统使用固定的线程数，当工作线程达到阈值时，接下来的请求会受到限制；

    2. QPS模式：限制每秒钟的请求处理数量。1秒内请求数量超过阈值时，请求会受到具体留空策略限制。


### 流控策略

    直接拒绝 | 匀速排队 | 慢速启动 | 慢启动匀速排队

#### 匀速排队: 仅对QPS模式生效，主要用于处理间隔性突发的流量。超过阈值的请求进入队列等待，设置默认等待时间(如500ms)
#### 慢速启动： 当流量突然增大，不希望系统突然间从空闲状态变化到繁忙状态，而是通过一段时间来慢慢切换。限流阈值从较低值达到设定阈值。

### 限流算法

    令牌桶算法 | 漏桶算法

### 原型实现

// 直接拒绝  

    (最大线程数, 当前线程数) -> {
        当前线程数 < 最大线程数, 接受请求, 分配线程处理请求
        当前线程数 >= 最大线程数, 拒绝请求
    }

// 匀速排队

    // 缺点：这种单个请求判断处理的方式，难以应对突发性的流量
    (最大线程数, 当前线程数, 缓冲队列) -> {
        当前线程数 < 最大线程数, 接受请求, 分配线程处理请求
        当前线程数 >= 最大线程数 && 缓冲队列未满, 请求信息写入队列
        当前线程数 >= 最大线程数 && 缓冲队列已满, 拒绝请求

        缓冲队列处理器(等待时间, 队列容量, 已用容量) -> {
            缓冲队列未满, 进入队列 -> {
                设置超时时间: 当前时间+等待时间
                请求信息写入队列
            }
            队列消费 -> {
                队列不为空 && 当前线程池资源存在空闲线程, 弹出队列
                循环读取，对队列元素进行超时判断，若超时，放弃改请求的处理，读取下一个线程
                存在空闲线程则分配线程处理请求
            }
        }
    }

// 令牌桶算法

    (最大线程数, 当前线程数, 缓冲队列) -> {
        当前线程数 < 最大线程数, 接受请求, 分配线程处理请求
        当前线程数 >= 最大线程数 && 缓冲队列未满, 请求信息写入队列
        当前线程数 >= 最大线程数 && 缓冲队列已满, 拒绝请求

        缓冲队列处理器(等待时间, 队列容量, 已用容量) -> {
            缓冲队列未满, 进入队列 -> {
                设置超时时间: 当前时间+等待时间
                请求信息写入队列
            }
            队列消费, (获取当前可处理请求数) -> {
                可处理请求数 >= 缓冲队列已用容量, 分配线程处理所有请求
                可处理请求数 < 缓冲队列已用容量, 弹出缓冲队列对应数量的未超时请求
            }
        }
    }

### 参考文章

1. [限流基础知识](https://mp.weixin.qq.com/s?__biz=MzI4Njg5MDA5NA==&mid=2247485652&idx=1&sn=dbcc843869bd94228cb71980cd84cc8c&chksm=ebd749d5dca0c0c30c0b11c0535005a9def3c66aa3f5c56d816256122b53f367de5f5ba6a6c3&token=1948873548&lang=zh_CN#rd)
2. [互联网限流相关的概念与算法](https://blog.csdn.net/hellozpc/article/details/107582330)
